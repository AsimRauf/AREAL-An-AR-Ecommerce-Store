version: 1
env:
  variables:
    NODE_ENV: production
frontend:
  phases:
    preBuild:
      commands:
        # Clean existing modules
        - rm -rf node_modules
        - rm -f package-lock.json
        # Install all dependencies
        - npm install
        # Explicitly install required packages
        - npm install --save-dev tailwindcss@3.3.0 postcss@8.4.31 autoprefixer@10.4.16 @tailwindcss/forms@0.5.7 postcss-import@15.1.0
        # Verify installations
        - npm list tailwindcss
        - npm list postcss-import
    build:
      commands:
        - export AWS_ACCESS_KEY_ID="${AACCESS_KEY_ID}"
        - export AWS_SECRET_ACCESS_KEY="${SECRET_ACCESS_KEY}"
        - export AWS_REGION="${REGION}"
        - export AWS_BUCKET_NAME="${BUCKET_NAME}"
        - export MONGODB_PASSWORD="${MONGODB_PASSWORD}"
        - export JWT_SECRET="${JWT_SECRET}"
        - export NEXTAUTH_SECRET="${NEXTAUTH_SECRET}"
        - export NEXTAUTH_URL="${NEXTAUTH_URL}"
        - export CLOUDFRONT_KEY_PAIR_ID="${CLOUDFRONT_KEY_PAIR_ID}"
        - export CLOUDFRONT_PRIVATE_KEY="${CLOUDFRONT_PRIVATE_KEY}"
        - export CLOUDFRONT_URL="${CLOUDFRONT_URL}"
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
  customHeaders:
    - pattern: "/api/*"
      headers:
        - key: "Cache-Control"
          value: "no-store"
    - pattern: "/*"
      headers:
        - key: "Strict-Transport-Security"
          value: "max-age=31536000; includeSubDomains"
